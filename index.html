function validate(){
  var e = {};
  if(mode === 'OUT'){
    if(!existingId) e.existingId = 'Select a person to sign out';
    var lastOut = existingId ? (lastByWorker && lastByWorker.get(existingId)) : null;
    if(!lastOut || lastOut.direction !== 'IN') e.notOnSite = true;
  } else {
    // Required fields when signing IN
    if(!name.trim()) e.name = 'Name is required';
    if(!company.trim()) e.company = 'Company is required';
    if(settings.requireInduction && !induction) e.induction = true;
    if(settings.requireRAMS && !rams) e.rams = true;
    var missing = (settings.requirePPE||[]).filter(function(id){ return !ppe.includes(id); });
    if(missing.length) e.ppe = missing;
    if(settings.requirePhoto && !photoDataUrl) e.photo = true;
    if(!ack) e.ack = true;

    // Block duplicate IN for the same record
    if(existingId){
      var lastInForExisting = lastByWorker && lastByWorker.get(existingId);
      if(lastInForExisting && lastInForExisting.direction === 'IN'){
        e.existingId = 'Selected person is already signed IN';
      }
    } else {
      // If creating a "new person", check by name+company to stop dupes already IN
      var nm = name.trim().toLowerCase();
      var co = (company||'').trim().toLowerCase();
      var cand = workers.find(function(w){
        return (w.name||'').trim().toLowerCase() === nm &&
               (w.company||'').trim().toLowerCase() === co;
      });
      if(cand){
        var lastCand = lastByWorker && lastByWorker.get(cand.id);
        if(lastCand && lastCand.direction === 'IN'){
          e.name = 'This person is already signed IN â€” choose them in "Existing person".';
        }
      }
    }
  }
  setErrors(e);
  return Object.keys(e).length === 0;
}
